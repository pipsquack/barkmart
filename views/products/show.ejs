<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>

  <%- include('../partials/datadog-rum') %>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body>
  <%- include('../partials/navbar') %>

  <% if (success) { %>
    <div class="alert alert-success alert-dismissible fade show m-3" role="alert">
      <%= success %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% } %>

  <% if (error) { %>
    <div class="alert alert-danger alert-dismissible fade show m-3" role="alert">
      <%= error %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% } %>

  <div class="container my-5">
    <div class="row">
      <div class="col-md-6">
        <% if (product.image_url) { %>
          <img src="<%= product.image_url %>" class="img-fluid rounded" alt="<%= product.name %>">
        <% } else { %>
          <div class="bg-secondary text-white d-flex align-items-center justify-content-center rounded" style="height: 400px;">
            <i class="bi bi-image" style="font-size: 5rem;"></i>
          </div>
        <% } %>
      </div>
      <div class="col-md-6">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item"><a href="/products">Products</a></li>
            <li class="breadcrumb-item active"><%= product.name %></li>
          </ol>
        </nav>

        <h1 class="mb-3"><%= product.name %></h1>
        <p class="text-muted">Category: <%= product.category.name %></p>
        <h2 class="text-primary mb-4"><%= formatPrice(product.price) %></h2>

        <p><%= product.description || 'No description available.' %></p>

        <div class="mb-4">
          <% if (product.stock_quantity > 0) { %>
            <p class="text-success"><i class="bi bi-check-circle"></i> In Stock (<%= product.stock_quantity %> available)</p>
          <% } else { %>
            <p class="text-danger"><i class="bi bi-x-circle"></i> Out of Stock</p>
          <% } %>
        </div>

        <% if (user && product.stock_quantity > 0) { %>
          <form id="addToCartForm">
            <div class="input-group mb-3" style="max-width: 200px;">
              <button class="btn btn-outline-secondary" type="button" onclick="decrementQuantity()">-</button>
              <input type="number" class="form-control text-center" id="quantity" value="1" min="1" max="<%= product.stock_quantity %>">
              <button class="btn btn-outline-secondary" type="button" onclick="incrementQuantity()">+</button>
            </div>
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="bi bi-cart-plus"></i> Add to Cart
            </button>
          </form>
        <% } else if (!user) { %>
          <a href="/auth/login" class="btn btn-primary btn-lg">Login to Purchase</a>
        <% } %>
      </div>
    </div>
  </div>

  <%- include('../partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script>
    function incrementQuantity() {
      const input = document.getElementById('quantity');
      const max = parseInt(input.max);
      const current = parseInt(input.value);
      if (current < max) {
        input.value = current + 1;
      }
    }

    function decrementQuantity() {
      const input = document.getElementById('quantity');
      const current = parseInt(input.value);
      if (current > 1) {
        input.value = current - 1;
      }
    }

    $('#addToCartForm').on('submit', function(e) {
      e.preventDefault();
      const quantity = $('#quantity').val();

      $.ajax({
        url: '/cart/add',
        method: 'POST',
        data: {
          product_id: <%= product.id %>,
          quantity: quantity
        },
        success: function(response) {
          if (response.success) {
            alert(response.message);
            $('.cart-badge').text(response.cartCount);
            if (response.cartCount > 0) {
              $('.cart-badge').show();
            }
          }
        },
        error: function(xhr) {
          const response = xhr.responseJSON;
          alert(response.message || 'Error adding to cart');
        }
      });
    });
  </script>
</body>
</html>
