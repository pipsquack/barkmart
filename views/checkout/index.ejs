<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>

  <%- include('../partials/datadog-rum') %>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body>
  <%- include('../partials/navbar') %>

  <% if (error) { %>
    <div class="alert alert-danger alert-dismissible fade show m-3" role="alert">
      <%= error %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% } %>

  <div class="container my-5">
    <h1 class="mb-4"><%= title %></h1>

    <form action="/checkout/process" method="POST">
      <div class="row">
        <div class="col-md-7">
          <!-- Shipping Address -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Shipping Address</h5>
            </div>
            <div class="card-body">
              <% if (addresses.length > 0) { %>
                <div class="mb-3">
                  <label class="form-label">Select Address</label>
                  <% addresses.forEach(address => { %>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="address_id" value="<%= address.id %>" id="address<%= address.id %>" <%= address.is_default ? 'checked' : '' %> onchange="toggleNewAddress(false)">
                      <label class="form-check-label" for="address<%= address.id %>">
                        <%= address.street_address %>, <%= address.city %>, <%= address.state %> <%= address.zip_code %>
                        <% if (address.is_default) { %><span class="badge bg-primary">Default</span><% } %>
                      </label>
                    </div>
                  <% }) %>
                  <div class="form-check mt-2">
                    <input class="form-check-input" type="radio" name="new_address" value="true" id="newAddress" onchange="toggleNewAddress(true)">
                    <label class="form-check-label" for="newAddress">
                      Use new address
                    </label>
                  </div>
                </div>
              <% } %>

              <div id="newAddressFields" style="<%= addresses.length > 0 ? 'display: none;' : '' %>">
                <input type="hidden" name="new_address" value="<%= addresses.length === 0 ? 'true' : 'false' %>" id="newAddressValue">
                <div class="mb-3">
                  <label for="street_address" class="form-label">Street Address</label>
                  <input type="text" class="form-control" id="street_address" name="street_address" <%= addresses.length === 0 ? 'required' : '' %>>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="city" class="form-label">City</label>
                    <input type="text" class="form-control" id="city" name="city" <%= addresses.length === 0 ? 'required' : '' %>>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="state" class="form-label">State</label>
                    <input type="text" class="form-control" id="state" name="state" <%= addresses.length === 0 ? 'required' : '' %>>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="zip_code" class="form-label">ZIP Code</label>
                    <input type="text" class="form-control" id="zip_code" name="zip_code" <%= addresses.length === 0 ? 'required' : '' %>>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="country" class="form-label">Country</label>
                  <input type="text" class="form-control" id="country" name="country" value="USA">
                </div>
              </div>
            </div>
          </div>

          <!-- Payment Method -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Payment Method</h5>
            </div>
            <div class="card-body">
              <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="payment_method" value="Credit Card" id="creditCard" checked>
                <label class="form-check-label" for="creditCard">
                  <i class="bi bi-credit-card"></i> Credit Card
                </label>
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="payment_method" value="PayPal" id="paypal">
                <label class="form-check-label" for="paypal">
                  <i class="bi bi-paypal"></i> PayPal
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="payment_method" value="Cash on Delivery" id="cod">
                <label class="form-check-label" for="cod">
                  <i class="bi bi-cash"></i> Cash on Delivery
                </label>
              </div>
            </div>
          </div>

          <!-- Order Notes -->
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Order Notes (Optional)</h5>
            </div>
            <div class="card-body">
              <textarea class="form-control" name="notes" rows="3" placeholder="Any special instructions for your order..."></textarea>
            </div>
          </div>
        </div>

        <div class="col-md-5">
          <!-- Order Summary -->
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Order Summary</h5>
            </div>
            <div class="card-body">
              <% cart.items.forEach(item => { %>
                <div class="d-flex justify-content-between mb-2">
                  <span><%= item.product.name %> Ã— <%= item.quantity %></span>
                  <span><%= formatPrice(item.product.price * item.quantity) %></span>
                </div>
              <% }) %>
              <hr>
              <div class="d-flex justify-content-between mb-2">
                <strong>Total:</strong>
                <strong class="text-primary"><%= formatPrice(cart.total) %></strong>
              </div>
              <button type="submit" class="btn btn-primary btn-lg w-100 mt-3">
                <i class="bi bi-check-circle"></i> Place Order
              </button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>

  <%- include('../partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function toggleNewAddress(show) {
      const fields = document.getElementById('newAddressFields');
      const value = document.getElementById('newAddressValue');
      const inputs = fields.querySelectorAll('input, textarea');

      if (show) {
        fields.style.display = 'block';
        value.value = 'true';
        inputs.forEach(input => input.required = true);
        // Clear address_id selection
        document.querySelectorAll('input[name="address_id"]').forEach(radio => radio.checked = false);
      } else {
        fields.style.display = 'none';
        value.value = 'false';
        inputs.forEach(input => input.required = false);
      }
    }
  </script>
</body>
</html>
