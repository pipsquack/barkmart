# Kubernetes Deployment

This directory contains Kubernetes manifests for deploying BarkMart.

## Prerequisites

- Kubernetes cluster (minikube, Docker Desktop, or cloud provider)
- kubectl installed and configured
- Kustomize (included in kubectl 1.14+)

## Secret Management

Secrets are **NOT stored in git**. They are automatically generated from your local `.env` file using Kustomize's `secretGenerator`.

### How It Works

1. **Single Source of Truth**: Your main `.env` file contains all secrets as `POSTGRES_*` variables
2. **Automatic Generation**: Kustomize reads `../.env` and generates the secret at deploy time
3. **Dynamic DATABASE_URL**: The application always constructs `DATABASE_URL` from `POSTGRES_*` environment variables at runtime

### Setup Secrets

Ensure your main `.env` file has all required secrets:

```bash
cat .env  # Verify secrets are present
```

Required variables in `.env`:
- `POSTGRES_HOST` (defaults to `localhost`, overridden to `postgres-service` in K8s)
- `POSTGRES_PORT` (defaults to `5432`)
- `POSTGRES_DB`
- `POSTGRES_USER`
- `POSTGRES_PASSWORD`
- `SESSION_SECRET`
- `DD_RUM_CLIENT_TOKEN`
- `DD_RUM_APPLICATION_ID`

## Deployment

### Option 1: Using Make (Recommended)

```bash
# From project root
make k8s-deploy
```

This will:
1. Deploy all resources with `kubectl apply -k k8s/`
2. Wait for PostgreSQL to be ready
3. Secrets are automatically generated from `.env`

### Option 2: Manual Deployment

```bash
# Deploy with Kustomize (reads from ../.env automatically)
kubectl apply -k k8s/

# Or individual steps:
kubectl apply -f k8s/namespace.yaml
kubectl apply -k k8s/
```

## Verify Deployment

```bash
# Check all resources
kubectl get all -n barkmart

# Check secrets (base64 encoded)
kubectl get secret barkmart-secret -n barkmart -o yaml

# View application logs
kubectl logs -f -l app=barkmart -n barkmart
```

## Files

- **kustomization.yaml** - Kustomize configuration with secretGenerator
- **secret.yaml.template** - Template showing what secrets are needed (for documentation only)
- **app-deployment.yaml** - Application deployment (constructs DATABASE_URL dynamically)
- **db-init-job.yaml** - Database initialization job
- **postgres-deployment.yaml** - PostgreSQL database
- **postgres-pvc.yaml** - Persistent volume for database
- **configmap.yaml** - Non-secret configuration
- **namespace.yaml** - Kubernetes namespace
- **ingress.yaml** - Ingress configuration

## Security Notes

- ✅ `.env` is gitignored (main secrets file)
- ✅ `secret.yaml` is gitignored (generated by Kustomize at deploy time)
- ✅ `secret.yaml.template` can be committed (no real secrets, documentation only)
- ✅ Kustomize generates secrets from `.env` when you run `kubectl apply -k k8s/`
- ✅ DATABASE_URL is constructed dynamically in deployment manifests
- ✅ No intermediate files needed

**Never commit files containing actual secrets!**

## How Secrets Are Used

### From .env to Kubernetes

```
Main .env file (gitignored)
      ↓
Kustomize reads ../.env
      ↓
Generates Secret at deploy time
      ↓
Pods reference Secret values
```

### DATABASE_URL Construction

There is **no** `DATABASE_URL` in the `.env` file. The application automatically constructs it from `POSTGRES_*` environment variables:

**In `config/database.js`:**
```javascript
const DATABASE_URL = `postgresql://${process.env.POSTGRES_USER}:${process.env.POSTGRES_PASSWORD}@${process.env.POSTGRES_HOST}:${process.env.POSTGRES_PORT}/${process.env.POSTGRES_DB}`;
```

**In Kubernetes deployments:**
```yaml
- name: POSTGRES_HOST
  value: "postgres-service"  # Override for K8s networking
- name: POSTGRES_PORT
  valueFrom:
    secretKeyRef:
      name: barkmart-secret
      key: POSTGRES_PORT
- name: POSTGRES_USER
  valueFrom:
    secretKeyRef:
      name: barkmart-secret
      key: POSTGRES_USER
# ... etc
```

This approach:
- ✅ Single source of truth: only `POSTGRES_*` variables in `.env`
- ✅ No duplication between component variables and DATABASE_URL
- ✅ Allows overriding `POSTGRES_HOST` for different environments (localhost → postgres → postgres-service)
- ✅ Database connection details are explicit and manageable

## Troubleshooting

### Secret not found error

Make sure your `.env` file exists in the project root:

```bash
ls -la ../.env  # Should exist
```

### Database connection errors

Check that POSTGRES_* environment variables are set correctly:

```bash
# Check POSTGRES_HOST
kubectl exec -it -n barkmart deployment/barkmart-app -- sh -c 'echo $POSTGRES_HOST'
# Should show: postgres-service

# Check all POSTGRES vars
kubectl exec -it -n barkmart deployment/barkmart-app -- sh -c 'env | grep POSTGRES'
```

The application automatically constructs `DATABASE_URL` from these variables in `config/database.js`.

### Updating secrets

1. Update main `.env` file
2. Redeploy: `kubectl apply -k k8s/`
3. Restart pods: `kubectl rollout restart deployment/barkmart-app -n barkmart`

The secret will be automatically regenerated from the updated `.env` file.

## Clean Up

```bash
# Delete all resources
kubectl delete namespace barkmart

# Or using Make
make k8s-delete
```
